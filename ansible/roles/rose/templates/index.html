<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Beardon Bathroom Occupancy</title>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            text-align: center;
            font-family: sans-serif;
        }
        .bathroom_status {
            display: inline-block;
        }
        .bathroom_status i {
            font-size: 200px;
        }
        .bathroom_status.occupied i,
        .bathroom_status.occupied h1 {
            color: red;
        }
        .bathroom_status.vacant i,
        .bathroom_status.vacant h1 {
            color: green;
        }
    </style>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.22/angular.min.js"></script>
    <script src="http://www.cornify.com/js/cornify.js"></script>
    <script src="./detectmobilebrowser.js"></script>
    <script type="application/javascript">
        angular.module('app', []);

        angular.module('app').controller('bathroom', ['$scope', '$http', function($scope, $http) {

            /* Probably doesn't work in IE. */
            function setFavicon(occupied) {
              // Create the new element, find the old one if present.
              var link = document.createElement('link'),
                  oldLink = document.getElementById('rose-favicon');

              // Meta
              link.id = 'rose-favicon';
              link.type = 'image/png';
              link.rel = 'shortcut icon';

              // Set the appropriate favicon.
              if(occupied) {
                link.href = './rose_occupied.png';
              } else link.href = './rose_vacant.png';

              // Drop the old one.
              if(oldLink) {
                document.getElementsByTagName('head')[0].removeChild(oldLink);
              }

              // Yay!
              document.getElementsByTagName('head')[0].appendChild(link);
            }

            function checkBathroom() {
                return $http.post('{{ spark_api_protocol }}://{{ spark_api_host }}/{{ spark_api_version }}/devices/{{ spark_device_id }}/checkRestrm?access_token={{ spark_access_token }}', {args: "port_a"} )
                    .then(function(res, status) {
                        return res.data.return_value > 3500;
                    }).then(function(occupied) {
                        $scope.occupied = occupied;
                        setFavicon(occupied);
                    }).catch(function(err) {
                        $scope.occupied = undefined;
                    });
            }

            checkBathroom();

            setInterval(checkBathroom, {{ check_interval }});
        }]);

        /* Detect IE */
        function isIE() { 
          return ((navigator.appName == 'Microsoft Internet Explorer')
            || ((navigator.appName == 'Netscape')
            && (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})")
            .exec(navigator.userAgent) != null)));
        };

        /* Redirect to IE version as appropriate. */
        if (!window.globalVariableThatDeterminesWhetherOrNotToRedirectIEUsersSuchThatIfItIsTrueTheyShouldNotBeRedirected
            && isIE()) {
          window.location = './iesupport.html';
        }

    </script>
</head>
<body ng-app="app" ng-controller="bathroom">
    <div>
        <div class="bathroom_status" ng-class="{ occupied: (occupied === true), vacant: (occupied === false) }">
            <div ng-if="occupied === true">
                <h1>Occupied</h1>
                <i class="fa fa-minus-circle" onclick="cornify_add(); document.getElementById('cornifycount').style.visibility='hidden'; return false;"></i>
                <p>The bathroom is currently occupied.</p>
            </div>
            <div ng-if="occupied === false">
                <h1>Vacant</h1>
                <i class="fa fa-circle-o"></i>
                <p>The bathroom is currently vacant.</p>
            </div>
            <div ng-if="occupied === undefined">
                <h1>Unknown</h1>
                <i class="fa fa-question"></i>
                <p>Something went wrong getting the data or something.</p>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">

/******************************************
* Snow Effect Script- By Altan d.o.o. (http://www.altan.hr/snow/index.html)
* Visit Dynamic Drive DHTML code library (http://www.dynamicdrive.com/) for full source code
* Last updated Nov 9th, 05' by DD. This notice must stay intact for use
******************************************/
  
  //Configure below to change URL path to the snow image
  var snowsrc="snow.gif"
  // Configure below to change number of snow to render
  var no = 10;
  // Configure whether snow should disappear after x seconds (0=never):
  var hidesnowtime = 0;
  // Configure how much snow should drop down before fading ("windowheight" or "pageheight")
  var snowdistance = "pageheight";

///////////Stop Config//////////////////////////////////

  var ie4up = (document.all) ? 1 : 0;
  var ns6up = (document.getElementById&&!document.all) ? 1 : 0;

	function iecompattest(){
	return (document.compatMode && document.compatMode!="BackCompat")? document.documentElement : document.body
	}

  var dx, xp, yp;    // coordinate and position variables
  var am, stx, sty;  // amplitude and step variables
  var i, doc_width = 800, doc_height = 600; 
  
  if (ns6up) {
    doc_width = self.innerWidth;
    doc_height = self.innerHeight;
  } else if (ie4up) {
    doc_width = iecompattest().clientWidth;
    doc_height = iecompattest().clientHeight;
  }

  dx = new Array();
  xp = new Array();
  yp = new Array();
  am = new Array();
  stx = new Array();
  sty = new Array();
  snowsrc=(snowsrc.indexOf("dynamicdrive.com")!=-1)? "snow.gif" : snowsrc
  for (i = 0; i < no; ++ i) {  
    dx[i] = 0;                        // set coordinate variables
    xp[i] = Math.random()*(doc_width-50);  // set position variables
    yp[i] = Math.random()*doc_height;
    am[i] = Math.random()*20;         // set amplitude variables
    stx[i] = 0.02 + Math.random()/10; // set step variables
    sty[i] = 0.7 + Math.random();     // set step variables
		if (ie4up||ns6up) {
      if (i == 0) {
        document.write("<div id=\"dot"+ i +"\" style=\"POSITION: absolute; Z-INDEX: "+ i +"; VISIBILITY: visible; TOP: 15px; LEFT: 15px;\"><a href=\"http://dynamicdrive.com\"><img src='"+snowsrc+"' border=\"0\"><\/a><\/div>");
      } else {
        document.write("<div id=\"dot"+ i +"\" style=\"POSITION: absolute; Z-INDEX: "+ i +"; VISIBILITY: visible; TOP: 15px; LEFT: 15px;\"><img src='"+snowsrc+"' border=\"0\"><\/div>");
      }
    }
  }

  function snowIE_NS6() {  // IE and NS6 main animation function
    doc_width = ns6up?window.innerWidth-10 : iecompattest().clientWidth-10;
		doc_height=(window.innerHeight && snowdistance=="windowheight")? window.innerHeight : (ie4up && snowdistance=="windowheight")?  iecompattest().clientHeight : (ie4up && !window.opera && snowdistance=="pageheight")? iecompattest().scrollHeight : iecompattest().offsetHeight;
    for (i = 0; i < no; ++ i) {  // iterate for every dot
      yp[i] += sty[i];
      if (yp[i] > doc_height-50) {
        xp[i] = Math.random()*(doc_width-am[i]-30);
        yp[i] = 0;
        stx[i] = 0.02 + Math.random()/10;
        sty[i] = 0.7 + Math.random();
      }
      dx[i] += stx[i];
      document.getElementById("dot"+i).style.top=yp[i]+"px";
      document.getElementById("dot"+i).style.left=xp[i] + am[i]*Math.sin(dx[i])+"px";  
    }
    snowtimer=setTimeout("snowIE_NS6()", 10);
  }

	function hidesnow(){
		if (window.snowtimer) clearTimeout(snowtimer)
		for (i=0; i<no; i++) document.getElementById("dot"+i).style.visibility="hidden"
	}
		

if (ie4up||ns6up){
    snowIE_NS6();
		if (hidesnowtime>0)
		setTimeout("hidesnow()", hidesnowtime*1000)
		}

</script>
</html>
